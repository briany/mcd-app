name: CI

on:
  push:
    branches:
      - master
      - feature/**
  pull_request:
    branches:
      - "*"

jobs:
  test-core-package:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Test MCDCore
        run: swift test --package-path packages/MCDCore

  test-shared-ui-package:
    runs-on: macos-latest
    needs: test-core-package
    steps:
      - uses: actions/checkout@v4
      - name: Test MCDSharedUI
        run: swift test --package-path packages/MCDSharedUI

  build-macos:
    runs-on: macos-latest
    needs: [test-core-package, test-shared-ui-package]
    steps:
      - uses: actions/checkout@v4
      - name: Build macOS app
        run: swift build --package-path apps/macos/MCD-macOS

  build-ios:
    runs-on: macos-latest
    needs: [test-core-package, test-shared-ui-package]
    steps:
      - uses: actions/checkout@v4
      - name: Build iOS app
        run: xcodebuild build -project apps/ios/MCD-iOS/MCD-iOS.xcodeproj -scheme MCD-iOS -destination 'platform=iOS Simulator,name=iPhone 15 Pro'

  test-web:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Unit tests
        run: npm test
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Build
        run: npm run build
      - name: E2E tests
        run: |
          npm run start -- --hostname 127.0.0.1 --port 3000 &
          SERVER_PID=$!
          npx wait-on http://127.0.0.1:3000
          npm run test:e2e
          kill $SERVER_PID
