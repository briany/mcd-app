# Web App 404 Errors - Root Cause and Fix

**Date:** 2026-01-19
**Issue:** All web API routes returning 404 errors despite valid MCP token
**Status:** ✅ RESOLVED

## Root Cause Analysis

### The Problem

The web app was making REST-style HTTP requests to the MCP server:

```typescript
// INCORRECT - REST approach
GET https://mcp.mcd.cn/mcp-servers/mcd-mcp/coupons
GET https://mcp.mcd.cn/mcp-servers/mcd-mcp/available-coupons
GET https://mcp.mcd.cn/mcp-servers/mcd-mcp/campaigns
```

**Result:** All requests returned 404 because these REST endpoints don't exist on the MCP server.

### The Protocol Mismatch

The MCP server uses **JSON-RPC protocol**, not REST. The Swift implementation (which works correctly) shows the proper format:

```swift
// CORRECT - JSON-RPC approach
POST https://mcp.mcd.cn/mcp-servers/mcd-mcp
Content-Type: application/json
Authorization: Bearer <token>

{
  "method": "tools/call",
  "params": {
    "name": "my-coupons",
    "arguments": {}
  }
}
```

## The Fix

### Files Changed

1. **`apps/web/src/lib/mcpClient.ts`**
   - Rewrote `callMcpTool()` function to use JSON-RPC format
   - Changed from GET requests to POST requests
   - Updated to use correct MCP tool names:
     - `my-coupons` (not `/coupons`)
     - `available-coupons` (not `/available-coupons`)
     - `campaign-calender` (not `/campaigns`)
     - `auto-bind-coupons` (not `/auto-claim`)
     - `now-time-info` (not `/time`)

2. **`apps/web/src/app/api/coupons/claim/route.ts`**
   - Updated to use `autoClaimCoupons()` instead of removed `claimCoupon()`
   - Note: MCP server only supports batch auto-claim, not individual claiming

3. **`apps/web/src/lib/config.ts`**
   - Removed deprecated REST endpoint helpers

## Before vs After

### Before (Broken)

```typescript
const request = async <T>(path: string, init?: RequestInit): Promise<T> => {
  const response = await fetch(withBase(path), {
    method: init?.method ?? "GET",  // ❌ Wrong: GET requests
    // ...
  });
  // ...
};

export const mcpClient = {
  getCoupons: () => request<CouponListResponse>("/coupons"),  // ❌ Wrong: REST path
};
```

**Result:** `GET /coupons` → 404 Not Found

### After (Fixed)

```typescript
const callMcpTool = async <T>(
  toolName: string,
  args?: Record<string, unknown>
): Promise<T> => {
  const body: MCPRequest = {
    method: "tools/call",              // ✅ JSON-RPC method
    params: {
      name: toolName,                   // ✅ Tool name
      ...(args && { arguments: args })
    },
  };

  const response = await fetch(getMcpBaseUrl(), {  // ✅ Base URL only
    method: "POST",                     // ✅ Always POST
    body: JSON.stringify(body),         // ✅ JSON-RPC body
    // ...
  });
  // ...
};

export const mcpClient = {
  getCoupons: () => callMcpTool<CouponListResponse>("my-coupons"),  // ✅ Tool name
};
```

**Result:** `POST /` with JSON-RPC body → 200 OK

## Verification

All API endpoints now returning 200 (success):

```bash
GET /api/coupons 200 in 634ms
GET /api/available-coupons 200 in 294ms
GET /api/campaigns 200 in 499ms
```

Sample response structure:

```json
{
  "jsonrpc": "2.0",
  "id": 0,
  "result": {
    "content": [
      {
        "text": "# 您的优惠券列表\n\n共 12 张可用优惠券...",
        "type": "text"
      }
    ],
    "isError": false
  }
}
```

## MCP Tool Names Reference

| Web Method | MCP Tool Name | Arguments |
|------------|---------------|-----------|
| `getCoupons()` | `my-coupons` | `{ page, pageSize }` (optional) |
| `getAvailableCoupons()` | `available-coupons` | None |
| `getCampaigns(date)` | `campaign-calender` | `{ specifiedDate }` (optional) |
| `autoClaimCoupons()` | `auto-bind-coupons` | None |
| `getTimeInfo()` | `now-time-info` | None |

## Lessons Learned

1. **Always match the server's protocol** - The Swift implementation was the reference for correct usage
2. **REST ≠ JSON-RPC** - Different architectural patterns require different request formats
3. **Tool names matter** - MCP uses specific tool naming conventions (e.g., `my-coupons` not `coupons`)
4. **Test early** - API integration should be tested with real server before building UI

## Related Documentation

- Swift MCPClient implementation: `packages/MCDCore/Sources/MCDCore/Services/MCPClient.swift`
- MCP Protocol: JSON-RPC 2.0 with `method: "tools/call"`
- MCP Server: https://mcp.mcd.cn/mcp-servers/mcd-mcp
